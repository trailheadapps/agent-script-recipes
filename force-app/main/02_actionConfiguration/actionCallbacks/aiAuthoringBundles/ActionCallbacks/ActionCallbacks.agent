# ActionCallbacks - Post-Action Processing
# This agent demonstrates running code after actions complete

config:
   agent_name: "ActionCallbacks"
   agent_label: "ActionCallbacks"
   agent_type: "AgentforceEmployeeAgent"
   description: "Processes payments with post-action callbacks"

variables:
   payment_amount: mutable number = 0
      description: "Payment amount"

   payment_method: mutable string = ""
      description: "Payment method used"

   transaction_id: mutable string = ""
      description: "Transaction ID from payment"

   payment_successful: mutable boolean = False
      description: "Whether payment succeeded"

   receipt_sent: mutable boolean = False
      description: "Whether receipt was sent"

   points_awarded: mutable number = 0
      description: "Loyalty points awarded"

system:
   messages:
      welcome: "I'll help you process your payment securely."
      error: "Payment processing error. Please try again."

   instructions: "You are a payment processing assistant that helps customers process payments and provides transaction confirmations. Never ask for card details, billing information, or other payment specifics."

start_agent topic_selector:
   description: "Welcome users and begin payment processing"
   
   reasoning:
      instructions:|
         Select the tool that best matches the user's message and conversation history. If it's unclear, make your best guess.
      actions:
         go_to_payment_processing: @utils.transition to @topic.payment_processing
            description: "User wants to make a payment, process a transaction, or ask about payment status, receipts, or loyalty points"

topic payment_processing:
   description: "Handles payment requests â€” collecting payment amount and method, processing transactions, sending receipts, awarding loyalty points, and logging for audit"

   actions:
      process_payment:
         description: "Processes a payment transaction"
         inputs:
            amount: number
               description: "The payment amount to be processed"
            method: string
               description: "The mode of the payment"
         outputs:
            transaction_id: string
               description: "Unique identifier for the completed transaction"
            success: boolean
               description: "Indicates whether the payment was processed successfully"
         target: "flow://ProcessPayment"
      send_receipt:
         description: "Sends payment receipt"
         inputs:
            transaction_id: string
               description: "The transaction ID to include in the receipt"
            amount: number
               description: "The payment amount to display on the receipt"
         outputs:
            sent: boolean
               description: "Indicates whether the receipt was sent successfully"
         target: "flow://SendReceipt"
      award_points:
         description: "Awards loyalty points"
         inputs:
            amount: number
               description: "The payment amount used to calculate loyalty points"
         outputs:
            points: number
               description: "The number of loyalty points awarded to the customer"
         target: "flow://AwardLoyaltyPoints"
      log_transaction:
         description: "Logs transaction for audit"
         inputs:
            transaction_id: string
               description: "The transaction ID to be logged for audit purposes"
         outputs:
            success: boolean
               description: "Indicates whether the transaction was logged successfully"
         target: "flow://LogTransaction"

   reasoning:
      instructions:->
         if not @variables.transaction_id:
            | Store the amount and method first, then process the payment.
              - Amount: ${!@variables.payment_amount}
              - Method: {!@variables.payment_method}
         else: 
            | Payment has been processed, inform the user:
              - Transaction: {!@variables.transaction_id}
              - Success: {!@variables.payment_successful}
              - Receipt sent: {!@variables.receipt_sent}
              - Points: {!@variables.points_awarded}
      actions:
         set_payment_info: @utils.setVariables
            with payment_amount=...
            with payment_method=...
         make_payment: @actions.process_payment
            with amount=...
            with method=@variables.payment_method
            set @variables.transaction_id = @outputs.transaction_id
            set @variables.payment_successful = @outputs.success
            run @actions.send_receipt
               with transaction_id=@variables.transaction_id
               with amount=@variables.payment_amount
               set @variables.receipt_sent = @outputs.sent
            run @actions.award_points
               with amount=@variables.payment_amount
               set @variables.points_awarded = @outputs.points
            run @actions.log_transaction
               with transaction_id=@variables.transaction_id