# AfterReasoning - Lifecycle Event Handling
# Demonstrates using the after_reasoning lifecycle event for cleanup and logging

config:
   agent_name: "AfterReasoning"
   agent_label: "AfterReasoning"
   agent_type: "AgentforceEmployeeAgent"
   description: "Demonstrates reasoning lifecycle events"

# Variables to track lifecycle execution
variables:
   session_start_time: mutable string = ""
      description: "When the session started"

   turn_count: mutable number = 0
      description: "Number of conversation turns"

system:
   messages:
      welcome: "Welcome! I demonstrate reasoning lifecycle events. This recipe is a simple example of how to use the after reasoning event. Simply ask anything to get started."
      error: "I encountered an issue during processing. Please try again."
   instructions: "You are a helpful assistant that demonstrates after reasoning event."

start_agent topic_selector:
   description: "Route every user message to the conversation topic for lifecycle event handling."
   
   reasoning:
      instructions:|
         ALWAYS call the begin_conversation tool for every user message, including greetings and chitchat.
         Do not respond directly. Route every message to the conversation topic.
      actions:
         begin_conversation: @utils.transition to @topic.conversation
            description: "Route to the conversation topic. MUST be called for every user message, including greetings and chitchat. Never skip this tool."

# Main conversation topic
topic conversation:
   description: "Provides a conversation with lifecycle event tracking. Your job is to run the after reasoning event as applicable on every request."

   actions:
      get_timestamp:
         description: "Get current timestamp"
         outputs:
            current_timestamp: string
               description: "Current timestamp in ISO 8601 format (YYYY-MM-DDTHH:mm:ss.sssZ)"
         target: "flow://GetCurrentTimestamp"

      log_event:
         description: "Log an event to the system"
         inputs:
            event_type: string
               description: "Type of event being logged (e.g., reasoning_started, reasoning_completed, user_greeted)"
            event_data: string
               description: "Additional data or context about the event being logged"
         outputs:
            logged: boolean
               description: "Indicates whether the event was successfully logged to the system"
         target: "flow://LogEvent"

   # Main reasoning block
   reasoning:
      instructions:->
         # Increment turn counter
         set @variables.turn_count = @variables.turn_count + 1
         # Initialize session start time on first turn
         if @variables.turn_count == 1:
            run @actions.get_timestamp
               set @variables.session_start_time = @outputs.current_timestamp
         # Log the reasoning start
         run @actions.log_event
            with event_type="reasoning_started"
            with event_data="Turn: {!@variables.turn_count}"

         | Every time you interact with the user, respond to their message showing this information and nothing else:
           
           - Session Start Time: {!@variables.session_start_time}
           - Current Turn Count: {!@variables.turn_count}


   # AFTER_REASONING: Runs after every turn.
   # Use for: Cleanup, final logging, state updates, analytics
   after_reasoning:
      # Log the reasoning completion
      run @actions.log_event
         with event_type="reasoning_completed"
         with event_data="Turn {!@variables.turn_count} completed"